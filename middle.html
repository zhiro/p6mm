<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/ol@v10.5.0/dist/ol.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.5.0/ol.css">
        <style>
            * {
                margin: 0;
            }
            #map {
                position: absolute;
                width: 100vw;
                height: 100vh;
            }
            #mic-id-wrapper {
                position: absolute;
                top: 10px;
                left: 10px;
                background: white;
                padding: 10px;
                border-radius: 4px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                z-index: 999999;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="mic-id-wrapper">
            <input type="text" id="mic-id" value="" />
            <button id="clear-map-button">Clear Map</button>
            <button id="simulate-sound-button">Simulate Sound</button>
        </div>

        <script>
                      // Microphone object
            function Microphone(id, lat, lon) {
                this.id = id;
                this.lat = lat;
                this.lon = lon;
            }

            // Sound event data
            function SoundEvent(timestamps) {
                this.timestamps = timestamps; // Object: { micId: timestamp }
            }

            document.addEventListener('DOMContentLoaded', function() {
                let map = null;
                let events = [];
                let savedMicId = localStorage.getItem('micId');

                let micSource = null; // Vector source for microphone markers
                let micLayer = null; // Layer for microphone markers
                let soundSource = null;
                let soundLayer = null;

                let soundEventTimestamps = {}; // Store timestamps for each microphone
                let temperature = 20; // 
                let microphones = []; // Array to store microphone data

                const micStyle = new ol.style.Style({
                  text: new ol.style.Text({
                    font: '13px Calibri,sans-serif',
                    offsetY: -12
                  }),
                  image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'red'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'black',
                        width: 2
                    })
                  }),
                });

               const soundStyle = new ol.style.Style({
                  text: new ol.style.Text({
                      font: '13px Calibri,sans-serif',
                      offsetY: -12
                    }),
                  image: new ol.style.Circle({
                      radius: 7,
                      fill: new ol.style.Fill({
                          color: 'green' // Sound source marker color
                      }),
                      stroke: new ol.style.Stroke({
                          color: 'black',
                          width: 2
                      })
                  })
                });

                const style = [micStyle, soundStyle];
                

                if (savedMicId) {
                    document.getElementById('mic-id').value = savedMicId;
                }

                function saveMicId() {
                    const micId = document.getElementById('mic-id').value;
                    localStorage.setItem('micId', micId);
                }

                let myLocation = {
                    lat: 59.25777249995653,
                    lng: 24.22070703941916
                };

                function initMap() {
                    map = new ol.Map({
                        target: 'map',
                        layers: [
                            new ol.layer.Tile({
                                source: new ol.source.OSM()
                            })
                        ],
                        view: new ol.View({
                            center: ol.proj.fromLonLat([myLocation.lng, myLocation.lat]),
                            zoom: 12
                        })
                    });

                    // Create the vector source and layer once
                    micSource = new ol.source.Vector();
                    micLayer = new ol.layer.Vector({
                        source: micSource,
                        style: function (feature) {
                          micStyle
                            .getText()
                            .setText([
                              ` ${feature.get('text')}`,
                              '',
                            ]);
                          return micStyle;
                        },
                    });

                    soundSource = new ol.source.Vector();
                    soundLayer = new ol.layer.Vector({
                        source: soundSource,
                        style: function (feature) {
                          soundStyle
                            .getText()
                            .setText([
                              ` ${feature.get('text')}`,
                              '',
                            ]);
                            return soundStyle;
                        },
                    });

                    map.addLayer(micLayer);
                    map.addLayer(soundLayer);

                }

                function clearMap() {
                  micSource.clear(); // Clear features from the source
                  soundSource.clear();
                  microphones = [];
                  soundEventTimestamps = {};
                }

                function sendEvent(event) {
                    fetch('/data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    });
                }

                function listEvents() {
                    fetch('/data')
                        .then(response => response.json())
                        .then(events => {
                            console.log('Events:', events);
                        });
                }

                function calculateArrivalTime(micLat, micLon, soundLat, soundLon) {
                    const distance = haversineDistance(micLat, micLon, soundLat, soundLon);
                    const speedOfSound = 343; // m/s
                    const time = distance / speedOfSound;
                    return time; // seconds
                }

                                // Function to calculate the distance between two coordinates using the Haversine formula
                function haversineDistance(lat1, lon1, lat2, lon2) {
                    const R = 6371; // Radius of the Earth in kilometers
                    const dLat = (lat2 - lat1) * (Math.PI / 180);
                    const dLon = (lon2 - lon1) * (Math.PI / 180);
                    const a =
                        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    const distance = R * c;
                    return distance;
                }

                function estimateLocation(micData) {
                    // Calculate the speed of sound based on temperature
                    const speedOfSound = 331.5 + (0.6 * temperature);

                    // Calculate the distances between microphones
                    for (let i = 0; i < micData.length; i++) {
                        for (let j = i + 1; j < micData.length; j++) {
                            const distBetweenMics = haversineDistance(
                                micData[i].latitude,
                                micData[i].longitude,
                                micData[j].latitude,
                                micData[j].longitude
                            );
                            // Calculate the time difference of arrival (TDOA)
                            const tdoa = distBetweenMics / speedOfSound;
                            // You would need more complex algorithms to solve for the sound source location
                            // This is a simplified example
                        }
                    }
                    // Simplified averaging of the microphone coordinates as a placeholder
                    let avgLat = 0;
                    let avgLon = 0;
                    for (const mic of micData) {
                        avgLat += mic.latitude;
                        avgLon += mic.longitude;
                    }
                    avgLat /= micData.length;
                    avgLon /= micData.length;

                    return {
                        latitude: avgLat,
                        longitude: avgLon
                    };
                }

                function simulateSound() {
                    if (microphones.length < 3) {
                        alert('Please place at least 3 microphones.');
                        return;
                    }

                    // Simulate a sound event at a random location
                    const soundLat = 59.25777249995653;
                    const soundLon = 24.22070703941916;

                    // Create a feature for the estimated location
                    const sourceFeature = new ol.Feature({
                        text: "source",
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([soundLon, soundLat])),
                    });

                    // Add the feature to the sound source layer
                    soundSource.addFeature(sourceFeature);

                                        // Calculate and display arrival times for each microphone
                    let arrivalTimes = {};
                    for (let mic of microphones) {
                        let arrivalTime = calculateArrivalTime(mic.lat, mic.lon, soundLat, soundLon);
                        arrivalTimes[mic.id] = arrivalTime;
                        console.log(`Microphone ${mic.id} arrival time: ${arrivalTime.toFixed(2)} seconds`);
                    }

                    const estimatedLocation = estimateLocation(microphones);

                                        // Create a feature for the estimated location
                    const calculatedFeature = new ol.Feature({
                        text: "calculation",
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([estimatedLocation.longitude, estimatedLocation.latitude])),
                    });

                    // Add the feature to the sound source layer
                    soundSource.addFeature(calculatedFeature);

                    alert(`Sound simulated at: ${soundLat.toFixed(2)}, ${soundLon.toFixed(2)}\nCheck console for arrival times.`);
                }

                initMap();

                
                map.on('click', function(evt) {
                        const coords = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
                        // Prompt for mic ID
                        const micId = prompt('Enter Microphone ID:');
                        if (micId) {
                            const mic = {
                                id: micId,
                                latitude: coords[1],
                                longitude: coords[0]
                            };
                            microphones.push(mic);
                          // Create a feature for the microphone
                          const feature = new ol.Feature({
                            text: micId,
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([mic.longitude, mic.latitude])),
                          });

                          // Add the feature to the source
                          micSource.addFeature(feature);
                        }
                    });
                  
                document.getElementById('clear-map-button').addEventListener('click', clearMap);
                document.getElementById('simulate-sound-button').addEventListener('click', simulateSound);
            });
        </script>
    </body>
</html>
